<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Guide Joaillerie 1-300 sans achat HV - WoW TBC Classic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS global (TOUT le style est dans assets) -->
    <link rel="stylesheet" href="../assets/css/site.css">
</head>

<body>
<!-- Navbar injectée par ../assets/js/nav.js -->

<header class="page-header">
    <h1>Joaillerie 1-300 sans achat HV</h1>
    <p>Basé sur le guide WowIsClassic, adapté pour tout farmer soi-même (minage + drops) en TBC Classic / pré-patch.</p>
</header>

<main class="container">

    <!-- ✅ Nouveau : pseudo + import/export JSON -->
    <section class="card">
        <h2>Mon stock (local PC)</h2>

        <div class="row" style="gap: 12px; align-items: end;">
            <div style="flex:1; min-width: 220px;">
                <label for="pseudo"><strong>Pseudo</strong></label>
                <input id="pseudo" type="text" placeholder="ex: Zaizai" />
                <p class="hint">
                    Le fichier exporté s'appellera : <strong><span id="file-preview">pseudo</span>_joa.json</strong>
                </p>
            </div>

            <button id="export-json" class="btn-primary">Exporter JSON</button>

            <label class="import-label btn-secondary" style="cursor:pointer;">
                Importer JSON
                <input id="import-file" type="file" accept=".json" style="display:none;">
            </label>

            <button id="reset-stock" class="btn-danger">Reset stock</button>
        </div>

        <p id="status" class="hint" style="margin-top: 10px;">
            Stock sauvegardé automatiquement sur ce PC (localStorage) pour le pseudo.
        </p>
    </section>

    <section class="card">
        <h2>Vue d'ensemble</h2>
        <p>
            Ce guide suit la route <strong>1-300</strong> de WowIsClassic, en supposant que tu ne veux
            <strong>rien acheter à l'HV</strong> : tu mines tes minerais, tu prospectes pour les gemmes
            et tu farms les composants qui tombent sur les monstres.
        </p>
        <p>Métiers conseillés&nbsp;:</p>
        <ul>
            <li><span class="tag">Joaillerie</span><span class="tag">Minage</span></li>
        </ul>
        <p>
            L'objectif est d'arriver 300 en <strong>minimisant les coûts</strong>, en utilisant surtout
            ce que tu loot / mines pendant ton leveling (Paladin Elfe de Sang Horde par exemple).
        </p>
    </section>

    <section class="card">
        <h2>Matériaux à prévoir 1-300 (liste du guide, orientée farm perso)</h2>

        <h3>Matériaux issus du minage / prospection</h3>
        <table>
            <thead>
            <tr>
                <th>Ressource</th>
                <th>Quantité</th>
                <th>Origine</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>Barre de cuivre</td><td>40</td><td class="origin-mining">Minerai de cuivre → fonderie</td></tr>
            <tr><td>Pierre brute</td><td>80</td><td class="origin-mining">Sous-produit du cuivre / étain</td></tr>
            <tr><td>Barre de bronze</td><td>80</td><td class="origin-mining">Barre de cuivre + barre d'étain</td></tr>
            <tr><td>Barre d'argent</td><td>50</td><td class="origin-mining">Minerai d'argent → fonderie</td></tr>
            <tr><td>Pierre lourde</td><td>80</td><td class="origin-mining">Sous-produit du fer</td></tr>
            <tr><td>Barre de mithril</td><td>100</td><td class="origin-mining">Minerai de mithril → fonderie</td></tr>
            <tr><td>Barre de vrai-argent</td><td>60</td><td class="origin-mining">Minerai de vrai-argent → fonderie</td></tr>
            <tr><td>Barre de thorium</td><td>50</td><td class="origin-mining">Minerai de thorium → fonderie</td></tr>
            <tr><td>Oeil de tigre</td><td>20</td><td class="origin-mining">Prospection cuivre</td></tr>
            <tr><td>Agate mousse</td><td>30</td><td class="origin-mining">Prospection étain / fer (ou drops)</td></tr>
            <tr><td>Citrine</td><td>10</td><td class="origin-mining">Prospection fer / mithril</td></tr>
            <tr><td>Aigue-marine</td><td>45</td><td class="origin-mining">Prospection fer / mithril</td></tr>
            <tr><td>Rubis étoilé</td><td>5</td><td class="origin-mining">Prospection thorium</td></tr>
            <tr><td>Grande opale</td><td>10</td><td class="origin-mining">Prospection thorium</td></tr>
            <tr><td>Saphir bleu</td><td>40</td><td class="origin-mining">Prospection thorium</td></tr>
            <tr><td>Diamant d'Azeroth</td><td>5</td><td class="origin-mining">Prospection thorium</td></tr>
            <tr><td>Énorme émeraude</td><td>20</td><td class="origin-mining">Prospection thorium</td></tr>
            </tbody>
        </table>

        <h3>Matériaux à looter (pas d'achat HV)</h3>
        <table>
            <thead>
            <tr>
                <th>Ressource</th>
                <th>Quantité</th>
                <th>Origine suggérée</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>Eau élémentaire</td><td>20</td><td class="origin-drop">Élémentaires d'eau (Marais, Tanaris, etc.)</td></tr>
            <tr><td>Flacon de mojo</td><td>60</td><td class="origin-drop">Trolls, humanoïdes haut niveau</td></tr>
            <tr><td>Coeur de fauve</td><td>20</td><td class="origin-drop">Bêtes haut niveau (Gangrebois, Winterspring...)</td></tr>
            </tbody>
        </table>

        <p class="hint">
            Le stock est mémorisé sur ce PC (localStorage) par pseudo. Tu peux exporter/importer en JSON.
        </p>
    </section>

    <section class="card">
        <h2>Route 1-300 étape par étape (adaptée farm perso)</h2>

        <h3 class="range">1 → 20</h3>
        <p><strong>Créer 20 × Fil de cuivre délicat</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Barre de cuivre">40 × Barre de cuivre</span></li>
        </ul>

        <h3 class="range">20 → 30</h3>
        <p><strong>Créer 10 × Statue en pierre brute</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Pierre brute">80 × Pierre brute</span></li>
        </ul>

        <h3 class="range">30 → 50</h3>
        <p><strong>Créer 20 × Bague d'oeil de tigre</strong></p>
        <ul>
            <li>20 × Fil de cuivre délicat (garde les 20 craftés au début)</li>
            <li><span class="route-ressource" data-ressource="Oeil de tigre">20 × Oeil de tigre (prospection cuivre)</span></li>
        </ul>

        <h3 class="range">50 → 75</h3>
        <p><strong>Créer 30 × Monture en bronze</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Barre de bronze">60 × Barre de bronze</span></li>
        </ul>
        <p class="hint">Garde ces montures pour plus tard (120-150).</p>

        <h3 class="range">75 → 80</h3>
        <p><strong>Créer 5 × Anneau solide en bronze</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Barre de bronze">20 × Barre de bronze</span></li>
        </ul>

        <h3 class="range">80 → 90</h3>
        <p><strong>Créer 10 × Anneau d'argent élégant</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Barre d'argent">10 × Barre d'argent</span></li>
        </ul>

        <h3 class="range">90 → 110</h3>
        <p><strong>Créer 20 × Anneau du pouvoir argenté</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Barre d'argent">40 × Barre d'argent</span></li>
        </ul>

        <h3 class="range">110 → 120</h3>
        <p><strong>Créer 10 × Statue en pierre lourde</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Pierre lourde">80 × Pierre lourde</span></li>
        </ul>

        <h3 class="range">120 → 150</h3>
        <p><strong>Créer 30 × Pendentif du bouclier d'agate</strong></p>
        <ul>
            <li>30 × Monture en bronze (garde celles faites 50-75 + complète au besoin)</li>
            <li><span class="route-ressource" data-ressource="Agate mousse">30 × Agate mousse (prospection étain / fer ou drops)</span></li>
        </ul>

        <h3 class="range">150 → 180</h3>
        <p><strong>Créer 30 × Filigrane en mithril</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Barre de mithril">60 × Barre de mithril</span></li>
        </ul>

        <h3 class="range">180 → 200</h3>
        <p><strong>Créer 20 × Anneau ciselé en vrai-argent</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Barre de vrai-argent">20 × Barre de vrai-argent</span></li>
            <li>40 × Filigrane en mithril (faits juste avant)</li>
        </ul>

        <h3 class="range">200 → 210</h3>
        <p><strong>Créer 10 × Anneau de citrine de soin accéléré</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Citrine">10 × Citrine</span></li>
            <li><span class="route-ressource" data-ressource="Barre de mithril">20 × Barre de mithril</span></li>
            <li><span class="route-ressource" data-ressource="Eau élémentaire">20 × Eau élémentaire (farm élémentaires)</span></li>
        </ul>

        <h3 class="range">210 → 225</h3>
        <p><strong>Créer 15 × Chevalière d'aigue-marine</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Aigue-marine">45 × Aigue-marine</span></li>
            <li><span class="route-ressource" data-ressource="Flacon de mojo">60 × Flacon de mojo (farm trolls / humanoïdes)</span></li>
        </ul>

        <h3 class="range">225 → 250</h3>
        <p><strong>Créer 25 × Monture en thorium</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Barre de thorium">25 × Barre de thorium</span></li>
        </ul>

        <h3 class="range">250 → 255</h3>
        <p><strong>Créer 5 × Bague de destruction rouge</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Rubis étoilé">5 × Rubis étoilé</span></li>
            <li>5 × Monture en thorium</li>
        </ul>

        <h3 class="range">255 → 265</h3>
        <p><strong>Créer 10 × Anneau de soin en vrai-argent</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Barre de vrai-argent">20 × Barre de vrai-argent</span></li>
            <li><span class="route-ressource" data-ressource="Coeur de fauve">20 × Coeur de fauve (farm bêtes)</span></li>
        </ul>

        <h3 class="range">265 → 275</h3>
        <p><strong>Créer 10 × Anneau d'opale simple</strong></p>
        <ul>
            <li>10 × Monture en thorium</li>
            <li><span class="route-ressource" data-ressource="Grande opale">10 × Grande opale</span></li>
        </ul>

        <h3 class="range">275 → 285</h3>
        <p><strong>Créer 10 × Chevalière de saphir</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Saphir bleu">40 × Saphir bleu</span></li>
            <li><span class="route-ressource" data-ressource="Barre de vrai-argent">20 × Barre de vrai-argent</span></li>
            <li>10 × Monture en thorium</li>
        </ul>

        <h3 class="range">285 → 290</h3>
        <p><strong>Créer 5 × Bague à diamant de focalisation</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Diamant d'Azeroth">5 × Diamant d'Azeroth</span></li>
            <li>5 × Monture en thorium</li>
        </ul>

        <h3 class="range">290 → 300</h3>
        <p><strong>Créer 10 × Anneau d'émeraude du lion</strong></p>
        <ul>
            <li><span class="route-ressource" data-ressource="Énorme émeraude">20 × Énorme émeraude</span></li>
            <li>10 × Monture en thorium</li>
        </ul>
    </section>

    <section class="card">
        <h2>Conseils spécial “je farm tout moi-même”</h2>
        <ul>
            <li><strong>Ne vends jamais minerais / pierres</strong> avant d'être 300 Joaillerie.</li>
            <li>Utilise ton <strong>Paladin</strong> pour farm en AoE les trolls / bêtes pour le mojo, les coeurs de fauve, etc.</li>
            <li>Prospecte systématiquement tes minerais dès que tu as un petit stock.</li>
            <li>Si un palier te semble trop cher, garde tes crafts verts/jaunes un peu plus longtemps.</li>
        </ul>
    </section>

    <div class="footer">
        Guide Joaillerie 1-300 (farm perso, minage + drops) — inspiré de WowIsClassic
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const STORAGE_KEY_PREFIX = 'joaillerie_stock_';

    function $(sel) { return document.querySelector(sel); }

    function sanitizePseudo(raw) {
        const p = String(raw || '').trim();
        return p.replace(/[^a-zA-Z0-9_-]/g, '');
    }

    function setStatus(msg) {
        const el = $('#status');
        if (el) el.textContent = msg;
    }

    function updateFilePreview() {
        const pseudo = sanitizePseudo($('#pseudo')?.value);
        const preview = pseudo ? pseudo : 'pseudo';
        const el = $('#file-preview');
        if (el) el.textContent = preview;
    }

    function downloadFile(filename, content, mime) {
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Ajoute les colonnes "Tu as" et "Manque" à chaque tableau
    function enhanceTables() {
        const tables = document.querySelectorAll('table');

        tables.forEach(function (table) {
            if (!table.tHead || !table.tBodies.length) return;

            const headerRow = table.tHead.rows[0];
            const headers = Array.from(headerRow.cells).map(th => th.textContent.trim().toLowerCase());
            if (headers.includes('tu as') || headers.includes('manque')) return;

            const thOwned = document.createElement('th');
            thOwned.textContent = 'Tu as';
            const thMissing = document.createElement('th');
            thMissing.textContent = 'Manque';

            headerRow.appendChild(thOwned);
            headerRow.appendChild(thMissing);

            Array.from(table.tBodies[0].rows).forEach(function (row) {
                const resName = row.cells[0].textContent.trim();
                const required = parseInt(row.cells[1].textContent.trim(), 10) || 0;

                const tdOwned = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.className = 'input-owned';
                input.dataset.ressource = resName;
                input.dataset.required = required;
                tdOwned.appendChild(input);
                row.appendChild(tdOwned);

                const tdMissing = document.createElement('td');
                const span = document.createElement('span');
                span.className = 'missing';
                tdMissing.appendChild(span);
                row.appendChild(tdMissing);
            });
        });
    }

    function updateRouteForResource(resourceName, isOk) {
        document.querySelectorAll('.route-ressource').forEach(function (el) {
            if (el.dataset.ressource === resourceName) {
                if (isOk) el.classList.add('route-ok');
                else el.classList.remove('route-ok');
            }
        });
    }

    function updateMissingForInput(input) {
        const required = parseInt(input.dataset.required, 10) || 0;
        const owned = parseInt(input.value, 10) || 0;
        const missing = Math.max(required - owned, 0);

        const row = input.closest('tr');
        const span = row ? row.querySelector('span.missing') : null;
        if (span) span.textContent = missing > 0 ? missing : 'OK';

        updateRouteForResource(input.dataset.ressource, missing === 0);
    }

    function updateAllMissing() {
        document.querySelectorAll('input.input-owned').forEach(updateMissingForInput);
    }

    function storageKeyForPseudo(pseudo) {
        return STORAGE_KEY_PREFIX + pseudo;
    }

    function loadStockForPseudo(pseudo) {
        const raw = localStorage.getItem(storageKeyForPseudo(pseudo));
        if (!raw) return null;
        try { return JSON.parse(raw); } catch { return null; }
    }

    function saveStockForPseudo(pseudo, ownedMap) {
        localStorage.setItem(storageKeyForPseudo(pseudo), JSON.stringify(ownedMap));
    }

    function applyOwnedMap(ownedMap) {
        document.querySelectorAll('input.input-owned').forEach(function (input) {
            const name = input.dataset.ressource;
            if (Object.prototype.hasOwnProperty.call(ownedMap, name)) {
                input.value = ownedMap[name];
            } else {
                input.value = "";
            }
        });
        updateAllMissing();
    }

    function collectOwnedMap() {
        const data = {};
        document.querySelectorAll('input.input-owned').forEach(function (input) {
            const name = input.dataset.ressource;
            const owned = parseInt(input.value, 10) || 0;
            data[name] = owned;
        });
        return data;
    }

    function tryAutoLoad() {
        const pseudo = sanitizePseudo($('#pseudo')?.value);
        if (!pseudo) return;

        const saved = loadStockForPseudo(pseudo);
        if (saved && typeof saved === 'object') {
            applyOwnedMap(saved);
            setStatus(`Stock chargé automatiquement pour "${pseudo}" depuis ce PC.`);
        } else {
            applyOwnedMap({});
            setStatus(`Aucun stock local trouvé pour "${pseudo}".`);
        }
    }

    // ===== Import / Export JSON =====

    function exportJSON() {
        const pseudo = sanitizePseudo($('#pseudo')?.value);
        if (!pseudo) {
            alert("Entre un pseudo avant d'exporter.");
            return;
        }

        const owned = collectOwnedMap();
        const payload = {
            version: 1,
            pseudo,
            exported_at: new Date().toISOString(),
            owned
        };

        saveStockForPseudo(pseudo, owned);

        const filename = `${pseudo}_joa.json`;
        downloadFile(filename, JSON.stringify(payload, null, 2), 'application/json;charset=utf-8');
        setStatus(`Export JSON OK : ${filename}`);
    }

    function importFromJSONText(text) {
        const data = JSON.parse(text);

        // Format attendu : { pseudo, owned: {...} }
        if (!data || typeof data !== 'object') throw new Error("JSON invalide.");
        if (!data.owned || typeof data.owned !== 'object') throw new Error("JSON invalide : champ 'owned' manquant.");

        // Si un pseudo est présent dans le fichier, on l'utilise (sinon, on garde l'entrée)
        const filePseudo = sanitizePseudo(data.pseudo || "");
        const inputPseudo = sanitizePseudo($('#pseudo')?.value);

        const pseudo = filePseudo || inputPseudo;
        if (!pseudo) throw new Error("Aucun pseudo : mets un pseudo ou utilise un JSON contenant 'pseudo'.");

        $('#pseudo').value = pseudo;
        updateFilePreview();

        applyOwnedMap(data.owned);
        saveStockForPseudo(pseudo, data.owned);

        setStatus(`Import JSON OK pour "${pseudo}" (sauvegardé sur ce PC).`);
    }

    function resetStock() {
        const pseudo = sanitizePseudo($('#pseudo')?.value);
        if (!confirm("Reset du stock affiché ?")) return;

        applyOwnedMap({});
        if (pseudo) saveStockForPseudo(pseudo, {});
        setStatus("Stock remis à zéro (local).");
    }

    // ===== Init =====
    enhanceTables();
    updateAllMissing();
    updateFilePreview();

    // Auto-load quand pseudo change (debounce light)
    let pseudoTimer = null;
    $('#pseudo')?.addEventListener('input', function () {
        updateFilePreview();
        clearTimeout(pseudoTimer);
        pseudoTimer = setTimeout(tryAutoLoad, 350);
    });

    // Live update: sauvegarde auto pour le pseudo
    document.addEventListener('input', function (e) {
        if (e.target && e.target.matches('input.input-owned')) {
            updateMissingForInput(e.target);
            const pseudo = sanitizePseudo($('#pseudo')?.value);
            if (pseudo) saveStockForPseudo(pseudo, collectOwnedMap());
        }
    });

    // Boutons
    $('#export-json')?.addEventListener('click', exportJSON);
    $('#reset-stock')?.addEventListener('click', resetStock);

    const importInput = $('#import-file');
    if (importInput) {
        importInput.addEventListener('change', function () {
            const file = importInput.files && importInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function () {
                try {
                    importFromJSONText(String(reader.result || ""));
                } catch (e) {
                    alert("Erreur import : " + e.message);
                }
                importInput.value = "";
            };
            reader.readAsText(file, 'utf-8');
        });
    }
});
</script>

<!-- Navbar -->
<script src="../assets/js/nav.js"></script>
</body>
</html>
