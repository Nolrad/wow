<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>D√©compte ‚Äì OaSiS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS global -->
    <link rel="stylesheet" href="../assets/css/site.css">
</head>

<body>
<!-- Navbar inject√©e par nav.js -->

<header class="page-header">
    <h1>D√©compte</h1>
    <p>Countdown + checklist de farm (synchronis√©e avec ton stock Joaillerie)</p>
</header>

<main class="container">

    <section class="card">
        <h2>Countdown</h2>
        <p class="muted">
            Choisis une date cible (format ISO). Exemple :
            <code>2026-01-01T00:00:00</code>
        </p>

        <div class="row">
            <input id="targetInput" placeholder="2026-01-01T00:00:00" />
            <button class="btn-primary" id="saveTargetBtn">Sauvegarder</button>
            <button class="btn-secondary" id="clearTargetBtn">Effacer</button>
        </div>

        <h3 class="range" id="countdownBig">--j --h --m --s</h3>
        <p class="muted" id="targetText">Aucune date d√©finie.</p>
    </section>

    <section class="card">
        <h2>Progression Joaillerie</h2>
        <p class="muted">
            Bas√© sur <code>localStorage["joaillerie_stock"]</code>.
            Ici tu vois ce qu‚Äôil te manque r√©ellement, tri√© pour le farm.
        </p>

        <div class="row" style="display:none;" id="noInlineNote"></div>

        <div class="row">
            <span class="pill" id="pillOk">OK: --</span>
            <span class="pill" id="pillMissing">Manquants: --</span>
            <span class="pill" id="pillTotal">Total: --</span>
            <span class="pill" id="pillPercent">Progression: --%</span>
        </div>

        <!-- La barre est construite en JS (pas de CSS inline) -->
        <div id="progressMount"></div>

        <div class="row" style="margin-top:12px;">
            <select id="viewMode">
                <option value="missing">Afficher : Manquants seulement</option>
                <option value="all">Afficher : Tout</option>
            </select>

            <select id="sortMode">
                <option value="missing_desc">Tri : Manque d√©croissant</option>
                <option value="name_asc">Tri : Nom A‚ÜíZ</option>
                <option value="required_desc">Tri : Requis d√©croissant</option>
            </select>

            <button class="btn-secondary" id="refreshBtn">Rafra√Æchir</button>
            <button class="btn-danger" id="resetStockBtn">Reset stock</button>
        </div>

        <div class="row" style="margin-top:12px;">
            <button class="btn-secondary" id="exportMissingTxt">Export manquants TXT</button>
            <button class="btn-secondary" id="exportMissingJson">Export manquants JSON</button>
            <button class="btn-secondary" id="exportMissingCsv">Export manquants CSV</button>

            <label class="import-label">
                Importer stock (JSON/TXT)
                <input id="importFile" type="file" accept=".json,.txt" style="display:none;">
            </label>
        </div>

        <table id="missingTable">
            <thead>
                <tr>
                    <th>Ressource</th>
                    <th>Requis</th>
                    <th>Poss√©d√©</th>
                    <th>Manque</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <p class="hint">
            Astuce : tu peux remplir le stock sur la page Joaillerie, puis revenir ici et cliquer ‚ÄúRafra√Æchir‚Äù.
        </p>
    </section>

    <footer class="footer">
        ¬© OaSiS ‚Äî D√©compte & Farming ‚Ä¢ GitHub Pages
    </footer>

</main>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // =========================
    // Countdown
    // =========================
    const TARGET_KEY = "decompte_target_iso";
    const targetInput = document.getElementById("targetInput");
    const saveTargetBtn = document.getElementById("saveTargetBtn");
    const clearTargetBtn = document.getElementById("clearTargetBtn");
    const countdownBig = document.getElementById("countdownBig");
    const targetText = document.getElementById("targetText");

    function loadTarget() {
        const saved = localStorage.getItem(TARGET_KEY);
        if (saved) targetInput.value = saved;
    }

    function formatCountdown(ms) {
        if (ms <= 0) return "üéâ C‚Äôest le moment !";
        const total = Math.floor(ms / 1000);
        const days = Math.floor(total / 86400);
        const hours = Math.floor((total % 86400) / 3600);
        const mins = Math.floor((total % 3600) / 60);
        const secs = total % 60;
        return `${days}j ${hours}h ${mins}m ${secs}s`;
    }

    function tickCountdown() {
        const iso = (targetInput.value || "").trim();
        if (!iso) {
            countdownBig.textContent = "--j --h --m --s";
            targetText.textContent = "Aucune date d√©finie.";
            return;
        }
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) {
            countdownBig.textConte
